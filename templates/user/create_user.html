{% extends 'base.html' %}

{% load web_filters %}

{% block scripts %}
    <script type="text/javascript">
        var passRegId = false;
        var passIdentity = false;
        var passPrivilege = true;
        var passStuID = false;

        function unique_ID(reg_ids , input) {
            var arr = reg_ids;
            var invalid_id = document.getElementById('invalid_id');

            for(var i = 0; i < arr.length; i++) {
                if (input.value === arr[i]) {
                    invalid_id.innerHTML = "<span style='color: red'>ＩＤ已存在</span>";
                    passRegId = false;
                    break;
                }
                else if (input.value === ""){
                    invalid_id.innerHTML = "<span style='color: red'>必填</span>";
                    passRegId = false;
                }
                else {
                    invalid_id.innerHTML = '<i class="fa fa-check"></i>';
                    passRegId = true;
                }
            }
            data_valid();
        }

        function unique_stuID(stu_ids , input) {
            var arr = stu_ids;
            var invalid_stu_id = document.getElementById('invalid_stu_id');

            for(var i = 0; i < arr.length; i++) {
                if (input.value === arr[i]) {
                    invalid_stu_id.innerHTML = "<span style='color: red'>ＩＤ已存在</span>";
                    passStuID = false;
                    break;
                } else if (input.value === ""){
                    invalid_stu_id.innerHTML = "<span style='color: red'>必填</span>";
                    passStuID = false;
                } else {
                    invalid_stu_id.innerHTML = '<i class="fa fa-check"></i>';
                    passStuID = true;
                }
            }
            data_valid();
        }

        // Checkout whether privilege is empty.
        function privilege_not_empty() {
            var privilegeInvalid = document.getElementById('privilege_invalid');
            var system = document.getElementById('32');
            var testM = document.getElementById('16');
            var tbM = document.getElementById('8');
            var tbO = document.getElementById('4');
            var viewer = document.getElementById('2');
            var testee = document.getElementById('1');

            if (system.checked === false && testM.checked === false && tbM.checked === false &&
                tbO.checked === false && viewer.checked === false && testee.checked === false) {
                privilegeInvalid.innerHTML = "<span style='color: red'>最少選一個選項</span>";
                passPrivilege = false;
            } else {
                privilegeInvalid.innerHTML = '<i class="fa fa-check"></i>';
                passPrivilege = true;
            }
            data_valid();
        }

        function is_student() {
            var stuID = document.getElementById('stu_id');
            var department = document.getElementById('department');
            var squadron = document.getElementById('squadron');
            var grade = document.getElementById('grade');
            var identity = document.getElementById('identity');

            if (identity.value === '2') {
                stuID.disabled = false;
                department.disabled = false;
                squadron.disabled = false;
                grade.disabled = false;

                passIdentity = true;
            }
            else {
                if (identity.value === ''){
                    passIdentity = false;
                } else{
                    passIdentity = true;}

                stuID.value = '';
                department.value = '';
                squadron.value = '';
                grade.value = '';

                document.getElementById('invalid_stu_id').innerHTML = '';

                stuID.disabled = true;
                department.disabled = true;
                squadron.disabled = true;
                grade.disabled = true;
            }
            data_valid();
        }

        function data_valid() {
            var identity = document.getElementById('identity');
            var submit = document.getElementById('submit');

            if(identity.value === '2'){
                if (passRegId===true && passIdentity===true && passPrivilege===true && passStuID===true){
                    submit.disabled = false;
                    submit.style.backgroundColor = "#4CCABD";
                } else {
                    submit.disabled = true;
                    submit.style.backgroundColor = "grey";
                }
            }
            else if(identity.value === '1' || identity.value === '3'){
                if (passRegId===true && passIdentity===true && passPrivilege===true){
                    submit.disabled = false;
                    submit.style.backgroundColor = "#4CCABD";
                } else{
                    submit.disabled = true;
                    submit.style.backgroundColor = "grey";
                }
            }
            else{
                submit.disabled = true;
                submit.style.backgroundColor = "grey";
            }
        }
    </script>
{% endblock %}


{% block path %}
    <a href="">系統管理員</a>
    <a class="fa fa-angle-double-right fa-lg box"></a>
    <a href="{% url 'user_list' %}">使用者列表</a>
    <a class="fa fa-angle-right fa-lg box"></a>
    <a href="">新增使用者（單一）</a>
{% endblock %}

{% block content %}
    <div class="create_user">
        <form method="post">
            <div class="title"><h1>User Create.</h1></div>
            {% csrf_token %}
                <table>
                    <tr>
                        <td>Reg ID</td>
                        <td>
                            <input type="text" id="reg_id" name="reg_id" placeholder="Register ID number..." onkeyup="unique_ID({{ reg_ids }}, this)" required>
                            <label class="unique_id" id="invalid_id"></label>
                        </td>
                    </tr>

                    <tr>
                        <td>身份</td>
                        <td>
                            <select id="identity" name="identity" onchange="is_student()" required>
                                <option value="" disabled selected>請選擇身份</option>
                                {% for identity in identities %}
                                    <option value="{{ identity.value.0 }}">{{ identity.value.1 }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td>權限</td>
                        <td>
                            {% for privilege in privileges.values %}
                                <input type="checkbox" id="{{ privilege.value.0 }}" name="privilege_{{ forloop.counter0 }}" onclick="privilege_not_empty()" {% if privilege == privileges.Testee %} checked {% endif %}>
                                <label for="{{ privilege.value.0 }}">{{ privilege.value.1 }}&nbsp;&nbsp;&nbsp;</label>
                            {% endfor %}
                            <label class="privilege_invalid" id="privilege_invalid"></label>
                        </td>
                    </tr>

                    <tr>
                        <td colspan="2" style="color: red; text-align: center">
                            --------------------身份非學生請勿填寫以下資訊--------------------
                        </td>
                    </tr>

                    <tr>
                        <td>Stu ID</td>
                        <td>
                            <input type="text" id="stu_id" name="stu_id" placeholder="Student ID number..." onkeyup="unique_stuID({{ stu_ids }}, this)" disabled>
                            <label class="unique_stu_id" id="invalid_stu_id"></label>
                        </td>
                    </tr>

                    <tr>
                        <td>科系</td>
                        <td>
                            <select name="department" id="department" disabled>
                                <option value="" disabled selected>請選擇科系</option>
                                {% for department in departments %}
                                    <option value="{{ department.id }}">{{ department }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td>中隊</td>
                        <td>
                            <select name="squadron" id="squadron" disabled>
                                <option value="" disabled selected>請選擇中隊單位</option>
                                {% for squadron in squadrons %}
                                    <option value="{{ squadron.id }}">{{ squadron }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <td>年班</td>
                        <td><input type="text" name="grade" id="grade" disabled></td>
                    </tr>

                </table>

                <div class="btn">
                    <button type="submit" id="submit" onclick="return confirm('確認新增？')" disabled>新增使用者</button>
                    <button type="reset">重設</button>
                    <button type="button" onclick="self.location=document.referrer;">取消</button>
                </div>
        </form>

        <style>
            .create_user .title h1{
                width: 30%;
                font-size: 28px;
                color: #FFFEF6;
                background-color: #4CCABD;
                padding-top: 10px;
                padding-bottom: 10px;
                padding-right: 15px;
                padding-left: 45px;
                text-align: center;
            }

            .create_user table{
                position: relative;
                left: 15%;

                width: 70%;

                font-size: 20px;
            }
            .create_user table td{
                padding: 4px;
            }
            .create_user form input{
                padding: 6px;

                border-style: solid;
                border-width: 0.1em;
                border-radius: 4px;
                border-color: rgb(220, 220, 220);
            }

            .create_user .btn{
                position: relative;
                top: 10px;
                left: 35%;
            }
            .create_user .btn #submit{
                background-color: grey;
            }

            .unique_id, .unique_stu_id, .privilege_invalid{
                color: limegreen;
            }
        </style>
    </div>

    <div class="mulit">
        <a href="{% url 'user_multiCreate' %}">一次新增多個使用者？</a>

        <style>
            .mulit a{
                position: absolute;
                top: 87%;
                left: 75%;
                color: #4CCABD;
                font-size: 25px;
                text-decoration: none;
            }
        </style>
    </div>
{% endblock %}